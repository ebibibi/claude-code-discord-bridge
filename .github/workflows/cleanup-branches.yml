name: Cleanup merged branches

on:
  schedule:
    - cron: '0 3 * * 0'  # æ¯Žé€±æ—¥æ›œ3:00 UTC
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Delete branches with merged/closed PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # squash merge ã‚’ä½¿ã†ã¨ git branch --merged ã§ã¯æ¤œå‡ºã§ããªã„ãŸã‚
          # GitHub API ã§ã€Œãƒžãƒ¼ã‚¸æ¸ˆã¿ or ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿ã® PR ã‚’æŒã¤ãƒ–ãƒ©ãƒ³ãƒã€ã‚’å‰Šé™¤ã™ã‚‹
          PROTECTED="^(main|master|develop|release/)"

          DELETED=0

          # ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿ PR ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—ã—ã¦å‰Šé™¤
          for branch in $(gh api repos/${{ github.repository }}/pulls \
              --method GET \
              --field state=closed \
              --field per_page=100 \
              --paginate \
              --jq '.[].head.ref' \
              | grep -vE "$PROTECTED" \
              | sort -u); do

            # ãã®ãƒ–ãƒ©ãƒ³ãƒãŒç¾åœ¨ãƒªãƒ¢ãƒ¼ãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰å‰Šé™¤
            if gh api "repos/${{ github.repository }}/git/refs/heads/$branch" \
                --silent 2>/dev/null; then
              echo "Deleting: $branch"
              gh api "repos/${{ github.repository }}/git/refs/heads/$branch" \
                --method DELETE
              DELETED=$((DELETED + 1))
            fi
          done

          echo "Deleted $DELETED branch(es)."

          if [ "$DELETED" -gt 0 ]; then
            curl -s -o /dev/null -w "%{http_code}" \
              -H "Content-Type: application/json" \
              -d "{\"content\": \"ðŸ§¹ **Branch cleanup** â€” ${DELETED} merged/closed branch(es) deleted.\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi
